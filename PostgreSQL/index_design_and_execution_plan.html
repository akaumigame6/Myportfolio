<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魔導書庫の探求：インデックスと実行計画の奥義</title>
    <link rel="stylesheet" href="index_design_and_execution_plan.css">
</head>

<body>

    <div class="container">

        <!-- 🍔 Hamburger Menu Button -->
        <button class="hamburger" id="hamburger-btn" aria-label="Menu">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <!-- 🛡️ Command Menu Overlay -->
        <nav class="command-menu" id="command-menu">
            <div class="menu-window pixel-box">
                <div class="menu-header">COMMAND MENU</div>
                <ul>
                    <li><a href="#chapter1"><span class="cursor">👉</span>第1章: 暗闇の書庫</a></li>
                    <li><a href="#chapter2"><span class="cursor">👉</span>第2章: 賢者の系譜</a></li>
                    <li><a href="#chapter3"><span class="cursor">👉</span>第3章: 禁忌の索引</a></li>
                    <li><a href="#chapter4"><span class="cursor">👉</span>第4章: 精霊の知恵</a></li>
                    <li><a href="#chapter5"><span class="cursor">👉</span>第5章: 預言書の解読</a></li>
                    <li><a href="#chapter6"><span class="cursor">👉</span>第6章: 真実の鏡</a></li>
                </ul>
                <button class="close-btn" id="close-btn">CLOSE [ESC]</button>
            </div>
        </nav>

        <header class="pixel-box">
            <div class="subtitle">CHAPTER 0: 新人司書の覚醒</div>
            <h1>魔導書庫の探求<br>〜インデックスと実行計画の奥義〜</h1>
            <div class="status-bar">
                <span class="hp">HP: 100/100</span>
                <span class="mp">MP: 50/50</span>
                <span>JOB: 魔導司書</span>
            </div>
        </header>

        <!-- 第1章 -->
        <section class="pixel-box" id="chapter1">
            <span class="tag tag-concept">基礎</span>
            <h2>第1章：暗闇の書庫と「探索コスト」</h2>

            <div class="story-box">
                <p>あなたは「無限の書庫」に配属されたばかりの新人司書。ある日、伝説の勇者から「10万年前の古文書」を探してほしいと依頼されます。しかし、書庫の棚は魔法の混乱によりバラバラ。端から1冊ずつ確認していくしかない状態です。これでは日が暮れるどころか、一生が終わってしまうことに気づきます。
                </p>
            </div>

            <div class="learning-box">
                <p><strong>📖 学習内容:</strong><br>
                    ・データが未整理な状態での検索コスト（全件スキャン）<br>
                    ・計算量 $O(n)$ の概念<br>
                    ・ディスクI/O（ページ読み込み）の重み
                </p>
            </div>

            <div class="exercise-box">
                <span class="exercise-title">⚔️ 演習：10万件のデータと戦え</span>
                <p>10万件の「魔法書データ」を用意し、インデックスなしで特定の1冊を検索して、その「重さ」を体感しましょう。</p>

                <pre><code>-- 10万件の魔法書データを召喚
CREATE TABLE grimoires (
    id SERIAL PRIMARY KEY,
    title TEXT,
    mana_cost INTEGER
);

INSERT INTO grimoires (title, mana_cost)
SELECT '魔法書_' || i, (random() * 1000)::INTEGER
FROM generate_series(1, 100000) AS i;

-- インデックスなしでの検索（全件走査）
\timing on
SELECT * FROM grimoires WHERE title = '魔法書_99999';</code></pre>

                <div class="execution-result">
                    id | title | mana_cost
                    ----+--------------+-----------
                    99999 | 魔法書_99999 | 452
                    (1 row)

                    時間: 45.123 ms (ミリ秒)
                    -- 解説: 全件を順番に調べたため、データの量（n）に比例して時間がかかります。</div>
            </div>
        </section>

        <!-- 第2章 -->
        <section class="pixel-box" id="chapter2">
            <span class="tag tag-concept">アルゴリズム</span>
            <h2>第2章：賢者の系譜「B-tree」の魔導構造</h2>

            <div class="story-box">
                <p>絶望するあなたに、大司書が「B-tree（賢者の系譜）」を授けます。それは、巨大な樹のように枝分かれした魔法の系譜図。根元（ルート）から順に「あちらの枝へ」「こちらの枝へ」とわずかな回数進むだけで、100万冊の中から目的の本が置かれた棚へ導かれます。
                </p>
            </div>

            <div class="learning-box">
                <p><strong>📖 学習内容:</strong><br>
                    ・B-tree（Balanced Tree）の階層構造<br>
                    ・ノード（枝）、リーフ（葉）、ポインタの役割<br>
                    ・探索計算量 $O(\log n)$ の驚異的な速さ
                </p>
            </div>

            <div class="term-box">
                <span class="term-title">用語：B-treeとは？</span>
                <p>データを常に整列した状態で保持する「木構造」の一つ。検索、挿入、削除が常に効率的に行えるように「平衡（バランス）」を保つよう設計されています。</p>
            </div>

            <div class="exercise-box">
                <span class="exercise-title">⚔️ 計算演習：対数の魔法</span>
                <p>100万件をB-treeで探す際、めくる「魔法のページ数」を計算しましょう。</p>
                <div class="quiz-container">
                    <h4>Q. 100万件のデータをB-treeで探すと、最大何回の比較で済む？</h4>
                    <p>全件スキャンなら最大1,000,000回ですが...？</p>
                    <details>
                        <summary>答えを見る</summary>
                        <div class="answer">
                            <p><strong>A. 約20回</strong></p>
                            <p>計算式：$\log_2(1,000,000) \approx 20$<br>
                                たった20回のチェック。これが「賢者の系譜」が爆速である理由です！</p>
                        </div>
                    </details>
                </div>
            </div>
        </section>

        <!-- 第3章 -->
        <section class="pixel-box" id="chapter3">
            <span class="tag tag-sql">SQL</span>
            <h2>第3章：禁忌の索引「INDEX」の付与</h2>

            <div class="story-box">
                <p>あなたはついに、書庫の棚に「魔法の索引（INDEX）」を刻み込みます。検索は一瞬になりましたが、新しい本が納品（INSERT）されるたびに、索引も魔力で書き換えなければなりません。納品作業に少し時間がかかるという「代償」の存在を学びます。
                </p>
            </div>

            <div class="learning-box">
                <p><strong>📖 学習内容:</strong><br>
                    ・CREATE INDEX コマンドの使い方<br>
                    ・インデックスによる劇的な検索高速化<br>
                    ・書き込みコスト（オーバーヘッド）の理解
                </p>
            </div>

            <div class="exercise-box">
                <span class="exercise-title">⚔️ 実技：索引の魔法を付与せよ</span>
                <pre><code>-- 魔法の索引を作成（インデックス装備！）
CREATE INDEX idx_grimoire_title ON grimoires(title);

-- 再度、検索を実行
SELECT * FROM grimoires WHERE title = '魔法書_99999';

-- [代償の計測] 大量に新刊を納品
INSERT INTO grimoires (title, mana_cost)
SELECT '新刊_' || i, (random() * 1000)::INTEGER
FROM generate_series(1, 10000) AS i;</code></pre>

                <div class="execution-result">
                    -- 検索結果:
                    時間: 0.234 ms (インデックス無しに比べて約200倍速！)

                    -- 納品（INSERT）の代償:
                    時間: 245 ms (インデックスが無い時は100ms程度だった作業が重くなった)
                    -- 解説: 検索は速くなりますが、データの書き換え時は索引もメンテナンスするため追加魔力が必要です。</div>
            </div>
        </section>

        <!-- 第4章 -->
        <section class="pixel-box" id="chapter4">
            <span class="tag tag-concept">最適化</span>
            <h2>第4章：精霊「オプティマイザ」と二つの探索法</h2>

            <div class="story-box">
                <p>魔法書庫には、最短ルートを導く精霊「オプティマイザ」が住んでいます。精霊は言います。「本が3冊しかないなら、索引を見るより全部見たほうが早いですよ」と。状況に応じて「全件走査（Seq
                    Scan）」か「索引走査（Index Scan）」かを選ぶ精霊の知恵を学びます。
                </p>
            </div>

            <div class="learning-box">
                <p><strong>📖 学習内容:</strong><br>
                    ・オプティマイザ（Optimizer）の役割<br>
                    ・Seq Scan vs Index Scan の違い<br>
                    ・選択率（Selectivity）による判断基準
                </p>
            </div>

            <div class="exercise-box">
                <span class="exercise-title">⚔️ 思考：精霊の計画を予想せよ</span>
                <div class="quiz-container">
                    <h4>Q. 100万件中「90万件」を取得する場合、精霊はどちらを選ぶ？</h4>
                    <details>
                        <summary>答えを見る</summary>
                        <div class="answer">
                            <p><strong>A. 全件走査（Seq Scan）</strong></p>
                            <p>ほぼ全てのデータを読み込む場合、索引を行き来するよりも、端から一気に読んだほうが速いため、精霊はあえて索引を使わない判断をします。これを「選択率が高い」と言います。</p>
                        </div>
                    </details>
                </div>
            </div>
        </section>

        <!-- 第5章 -->
        <section class="pixel-box" id="chapter5">
            <span class="tag tag-sql">分析</span>
            <h2>第5章：精霊の預言書「EXPLAIN」を読み解く</h2>

            <div class="story-box">
                <p>精霊オプティマイザは、探索を始める前に「預言書（EXPLAIN）」を提示します。そこには「この探索にはこれだけの魔力（Cost）が必要だ」と書かれています。預言書に書かれた暗号を読み解く力こそ、一流司書の証です。
                </p>
            </div>

            <div class="learning-box">
                <p><strong>📖 学習内容:</strong><br>
                    ・EXPLAIN コマンドの基本<br>
                    ・Cost（魔力コスト）、Rows（予想行数）、Width（データの幅）の読み方<br>
                    ・実行計画の木構造の理解
                </p>
            </div>

            <div class="exercise-box">
                <span class="exercise-title">⚔️ 予言：暗号を解読せよ</span>
                <pre><code>-- 預言書（実行計画）を表示
EXPLAIN SELECT * FROM grimoires WHERE title = '魔法書_500';</code></pre>

                <div class="execution-result">
                    QUERY PLAN
                    ------------------------------------------------------------------------------------
                    Index Scan using idx_grimoire_title on grimoires (cost=0.29..8.30 rows=1 width=15)
                    Index Cond: (title = '魔法書_500'::text)
                    -- 解読：
                    -- cost=0.29..8.30 : 最小0.29、最大8.30の魔力コストが必要と予想。
                    -- rows=1 : 1枚の魔法書が見つかると精霊が予想している。</div>
            </div>
        </section>

        <!-- 第6章 -->
        <section class="pixel-box" id="chapter6">
            <span class="tag tag-danger">重要</span>
            <h2>第6章：真実の鏡「EXPLAIN ANALYZE」</h2>

            <div class="story-box">
                <p>預言書はあくまで精霊の予測。時には精霊の勘違い（古い統計情報）で、予測以上の魔力を消費することもあります。あなたは「真実の鏡（ANALYZE）」を使い、実際に探索を行って「本当にかかった時間」を突き合わせる禁術を学びます。
                </p>
            </div>

            <div class="learning-box">
                <p><strong>📖 学習内容:</strong><br>
                    ・EXPLAIN ANALYZE による実測値の取得<br>
                    ・予測（Estimated）と実測（Actual）の乖離の分析<br>
                    ・ANALYZE コマンドによる統計情報の更新
                </p>
            </div>

            <div class="exercise-box">
                <span class="exercise-title">⚔️ 真実：精霊の目を覚まさせろ</span>
                <pre><code>-- 実際に実行して、真実の鏡で見る
EXPLAIN ANALYZE SELECT * FROM grimoires WHERE mana_cost > 950;

-- 統計情報が古いと、精霊が間違ったルートを選ぶことがある。
-- 精霊に最新の書架情報を与えて目覚めさせる。
ANALYZE grimoires;</code></pre>

                <div class="execution-result">
                    QUERY PLAN
                    ------------------------------------------------------------------------------
                    Seq Scan on grimoires (cost=0.00..1876.00 rows=10000 width=14)
                    (actual time=0.015..9.52ms rows=5120 loops=1)
                    -- 解説:
                    -- (rows=10000) は精霊の予測。
                    -- (actual rows=5120) は真実。
                    -- ズレが大きい場合は ANALYZE で精霊の知識をアップデートする必要があります！</div>
            </div>
        </section>

        <footer>
            <p>YOU ARE NOW A MASTER LIBRARIAN.</p>
            <p>© 2026 魔導データ探索ギルド</p>
        </footer>

    </div>

    <script>
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const closeBtn = document.getElementById('close-btn');
        const commandMenu = document.getElementById('command-menu');
        const menuLinks = document.querySelectorAll('.command-menu a');

        const toggleMenu = () => {
            commandMenu.classList.toggle('active');
            hamburgerBtn.classList.toggle('active');
        };

        hamburgerBtn.addEventListener('click', toggleMenu);
        closeBtn.addEventListener('click', toggleMenu);

        menuLinks.forEach(link => {
            link.addEventListener('click', () => {
                commandMenu.classList.remove('active');
                hamburgerBtn.classList.remove('active');
            });
        });

        // Close on ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && commandMenu.classList.contains('active')) {
                toggleMenu();
            }
        });
    </script>

</body>

</html>